import streamlit as st
import pandas as pd
from supabase import create_client, Client
from datetime import datetime, date
import calendar
from st_aggrid import AgGrid, GridOptionsBuilder, GridUpdateMode, DataReturnMode, JsCode

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ì›”ê°„ì‹¤ì  - ì‹œê³µí˜„í™©",
    page_icon="ğŸ“Š",
    layout="wide"
)

# Supabase ì—°ê²° ì„¤ì •
@st.cache_resource
def init_supabase():
    try:
        # secrets.tomlì—ì„œ Supabase ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        url = st.secrets["SUPABASE_URL"]
        key = st.secrets["SUPABASE_KEY"]
        
        return create_client(url, key)
    except Exception as e:
        st.error(f"Supabase ì—°ê²° ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {str(e)}")
        st.info("secrets.toml íŒŒì¼ì— SUPABASE_URLê³¼ SUPABASE_KEYê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
        return None

# ì‚¬ìš© ê°€ëŠ¥í•œ í…Œì´ë¸” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
@st.cache_data(ttl=3600)
def get_available_tables():
    try:
        supabase = init_supabase()
        
        if supabase is None:
            return []
        
        # PostgreSQL ì‹œìŠ¤í…œ í…Œì´ë¸”ì—ì„œ ì‚¬ìš©ì í…Œì´ë¸” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        response = supabase.rpc('get_tables').execute()
        return response.data if response.data else []
    except:
        # RPCê°€ ì‹¤íŒ¨í•˜ë©´ ì§ì ‘ ì¿¼ë¦¬ ì‹œë„
        try:
            response = supabase.table('information_schema.tables').select('table_name').eq('table_schema', 'public').execute()
            return [item['table_name'] for item in response.data] if response.data else []
        except:
            return []

# construction_status ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
@st.cache_data(ttl=3600)  # 1ì‹œê°„ë§ˆë‹¤ ìºì‹œ ê°±ì‹ 
def get_construction_status():
    try:
        supabase = init_supabase()
        
        if supabase is None:
            return pd.DataFrame()
        
        # construction_status í…Œì´ë¸”ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        response = supabase.table('construction_status').select('*').execute()
        
        if response.data:
            df = pd.DataFrame(response.data)
            st.success(f"ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì„±ê³µ! ì´ {len(df)} ê±´ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.")
            
            # í…Œì´ë¸” êµ¬ì¡° í™•ì¸ì„ ìœ„í•œ ë””ë²„ê¹… ì •ë³´
            st.info(f"í…Œì´ë¸” ì»¬ëŸ¼: {list(df.columns)}")
            if not df.empty:
                st.info(f"ì²« ë²ˆì§¸ í–‰ ë°ì´í„°: {df.iloc[0].to_dict()}")
            
            # ë‚ ì§œ ì»¬ëŸ¼ì„ datetimeìœ¼ë¡œ ë³€í™˜
            if 'ë‚ ì§œ' in df.columns:
                df['ë‚ ì§œ'] = pd.to_datetime(df['ë‚ ì§œ'])
            elif 'date' in df.columns:
                df['ë‚ ì§œ'] = pd.to_datetime(df['date'])
            elif 'created_at' in df.columns:
                df['ë‚ ì§œ'] = pd.to_datetime(df['created_at'])
            
            # ìœ„ì¹˜ ì»¬ëŸ¼ í™•ì¸
            if 'ìœ„ì¹˜' not in df.columns:
                # ìœ„ì¹˜ ê´€ë ¨ ì»¬ëŸ¼ ì°¾ê¸°
                location_cols = [col for col in df.columns if 'ìœ„ì¹˜' in col or 'location' in col.lower() or 'name' in col.lower()]
                if location_cols:
                    df['ìœ„ì¹˜'] = df[location_cols[0]]
                    st.info(f"'{location_cols[0]}' ì»¬ëŸ¼ì„ 'ìœ„ì¹˜'ë¡œ ë§¤í•‘í–ˆìŠµë‹ˆë‹¤.")
                else:
                    st.warning("ìœ„ì¹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì»¬ëŸ¼ì„ ìœ„ì¹˜ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.")
                    df['ìœ„ì¹˜'] = df.iloc[:, 0]
            
            # ì§„í–‰ë¥  ì»¬ëŸ¼ í™•ì¸
            if 'ì§„í–‰ë¥ ' not in df.columns:
                # ì§„í–‰ë¥  ê´€ë ¨ ì»¬ëŸ¼ ì°¾ê¸°
                progress_cols = [col for col in df.columns if 'ì§„í–‰ë¥ ' in col or 'progress' in col.lower() or 'rate' in col.lower() or 'percent' in col.lower()]
                if progress_cols:
                    df['ì§„í–‰ë¥ '] = df[progress_cols[0]]
                    st.info(f"'{progress_cols[0]}' ì»¬ëŸ¼ì„ 'ì§„í–‰ë¥ 'ë¡œ ë§¤í•‘í–ˆìŠµë‹ˆë‹¤.")
                else:
                    st.warning("ì§„í–‰ë¥  ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ«ì ì»¬ëŸ¼ì„ ì°¾ì•„ ì§„í–‰ë¥ ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.")
                    numeric_cols = df.select_dtypes(include=['number']).columns
                    if len(numeric_cols) > 0:
                        df['ì§„í–‰ë¥ '] = df[numeric_cols[0]]
                        st.info(f"'{numeric_cols[0]}' ì»¬ëŸ¼ì„ 'ì§„í–‰ë¥ 'ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.")
                    else:
                        df['ì§„í–‰ë¥ '] = 0
            
            return df
        else:
            st.warning("construction_status í…Œì´ë¸”ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return pd.DataFrame()
    except Exception as e:
        st.error(f"ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜: {str(e)}")
        # ë” ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´ í‘œì‹œ
        st.error("í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì ‘ê·¼ ê¶Œí•œì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        return pd.DataFrame()

# í•­ìƒ ë³´ì—¬ì§€ëŠ” í…Œì´ë¸” êµ¬ì¡° ìƒì„±
def create_base_table():
    # ê¸°ë³¸ êµ¬ì¡° ìƒì„± (í•­ìƒ ë³´ì—¬ì§)
    construction_items = [
        "1. ë³¸ì„ í„°ë„ (1êµ¬ê°„, ëŒ€ë¦¼-ì‹ í’)",
        "1. ë³¸ì„ í„°ë„ (1êµ¬ê°„, ëŒ€ë¦¼-ì‹ í’) ë¼ì´ë‹",
        "2. ì‹ í’ì •ê±°ì¥ - 1)ì •ê±°ì¥ ë¼ì´ë‹",
        "2. ì‹ í’ì •ê±°ì¥ - 1)ì •ê±°ì¥ ë¯¸ë“¤ ìŠ¬ë¼ë¸Œ",
        "2. ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ ìˆ˜ì§êµ¬ ë¼ì´ë‹",
        "2. ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (1)PCB ì •ê±°ì¥ ë°©ë©´ ë¼ì´ë‹",
        "2. ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (1)PCB í™˜ìŠ¹í†µë¡œ ë°©ë©´ ë¼ì´ë‹",
        "2. ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (2)PCC ë¼ì´ë‹",
        "2. ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (3)PCD ë¼ì´ë‹",
        "2. ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (4)PHA ë¼ì´ë‹",
        "2. ì‹ í’ì •ê±°ì¥ - 3)íŠ¹ë³„í”¼ë‚œê³„ë‹¨ - ìˆ˜ì§êµ¬ ë¼ì´ë‹",
        "2. ì‹ í’ì •ê±°ì¥ - 3)íŠ¹ë³„í”¼ë‚œê³„ë‹¨ - PHB ë¼ì´ë‹",
        "2. ì‹ í’ì •ê±°ì¥ - 4)ì™¸ë¶€ì¶œì…êµ¬ ì¶œì…êµ¬(#3) êµ´ì°©",
        "2. ì‹ í’ì •ê±°ì¥ - 4)ì™¸ë¶€ì¶œì…êµ¬ ì¶œì…êµ¬(#2) êµ´ì°©",
        "2. ì‹ í’ì •ê±°ì¥ - 4)ì™¸ë¶€ì¶œì…êµ¬ ì¶œì…êµ¬(#1) êµ´ì°©",
        "3. ì‹ í’ í™˜ìŠ¹í†µë¡œ - 1)í™˜ìŠ¹í„°ë„ ì—°ê²°í„°ë„(PCF) êµ´ì°©",
        "3. ì‹ í’ í™˜ìŠ¹í†µë¡œ - 1)í™˜ìŠ¹í„°ë„ ì—°ê²°í„°ë„(PCF) ë¼ì´ë‹",
        "3. ì‹ í’ í™˜ìŠ¹í†µë¡œ - 1)í™˜ìŠ¹í„°ë„ ì—°ê²°í„°ë„(PCE) êµ´ì°©",
        "3. ì‹ í’ í™˜ìŠ¹í†µë¡œ - 1)í™˜ìŠ¹í„°ë„ ì—°ê²°í„°ë„(PCE) ë¼ì´ë‹",
        "3. ì‹ í’ í™˜ìŠ¹í†µë¡œ - 2)ê°œì°© BOX ë³´ë¼ë§¤ ë°©ë©´ êµ¬ì¡°ë¬¼",
        "3. ì‹ í’ í™˜ìŠ¹í†µë¡œ - 2)ê°œì°© BOX ëŒ€ë¦¼ ë°©ë©´ êµ´ì°©",
        "4. ë³¸ì„ í„°ë„(2êµ¬ê°„, ì‹ í’-ë„ë¦¼) êµ´ì°©",
        "4. ë³¸ì„ í„°ë„(2êµ¬ê°„, ì‹ í’-ë„ë¦¼) ë¼ì´ë‹",
        "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 1)ì •ê±°ì¥ í„°ë„ ë¼ì´ë‹",
        "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 1)ì •ê±°ì¥ ë¯¸ë“¤ ìŠ¬ë¼ë¸Œ",
        "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 2)ì¶œì…êµ¬#1 ìˆ˜ì§êµ¬ ë¼ì´ë‹",
        "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 2)ì¶œì…êµ¬#1 PCA ë¼ì´ë‹",
        "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 2)ì¶œì…êµ¬#1 PCC ë¼ì´ë‹",
        "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 2)ì¶œì…êµ¬#1 PHA ë¼ì´ë‹",
        "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 3)ì¶œì…êµ¬#2 ìˆ˜ì§êµ¬ ë¼ì´ë‹",
        "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 3)ì¶œì…êµ¬#2 PCA ë¼ì´ë‹",
        "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 3)ì¶œì…êµ¬#2 PCC ë¼ì´ë‹",
        "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 3)ì¶œì…êµ¬#2 PHB ë¼ì´ë‹"
    ]
    
    # ê¸°ë³¸ í…Œì´ë¸” êµ¬ì¡° ìƒì„±
    base_data = []
    for item in construction_items:
        row_data = {
            'ìœ„ì¹˜': item,
            'ì„¤ê³„': 'ì„¤ê³„ê°’',  # ì‹¤ì œ ì„¤ê³„ê°’ì€ ë³„ë„ í…Œì´ë¸”ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨
            'ì „ì²´': 0,        # ê³ ì •ì—´
            'ëˆ„ê³„': 0,        # ê³ ì •ì—´
            'ì§„ë„ìœ¨': 0,      # ê³ ì •ì—´
            'ì”ì—¬': 0         # ê³ ì •ì—´
        }
        
        # 25-01ë¶€í„° 26-12ê¹Œì§€ì˜ ì›”ë³„ ì»¬ëŸ¼ë“¤ ì¶”ê°€ (ê³ ì •ì—´)
        for year in [25, 26]:
            for month in range(1, 13):
                month_col = f"{year:02d}-{month:02d}"
                row_data[month_col] = 0
        
        # ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ì—´ë“¤ë„ í¬í•¨
        if 'custom_columns' in st.session_state:
            for col_name, default_value in st.session_state.custom_columns.items():
                row_data[col_name] = default_value
        
        base_data.append(row_data)
    
    return pd.DataFrame(base_data)

# ì‚¬ìš©ì ì •ì˜ ì—´ ì¶”ê°€ í•¨ìˆ˜
def add_custom_column():
    if 'custom_columns' not in st.session_state:
        st.session_state.custom_columns = {}
    
    with st.expander("â• ìƒˆë¡œìš´ ì—´ ì¶”ê°€", expanded=False):
        col1, col2, col3 = st.columns([2, 2, 1])
        
        with col1:
            new_column_name = st.text_input("ìƒˆ ì—´ ì´ë¦„", placeholder="ì˜ˆ: ê³„ì•½ê¸ˆì•¡, ì™„ë£Œìœ¨ ë“±")
        
        with col2:
            default_value = st.text_input("ê¸°ë³¸ê°’", placeholder="ì˜ˆ: 0, ë¯¸ì™„ë£Œ ë“±")
        
        with col3:
            if st.button("ì—´ ì¶”ê°€", type="primary"):
                if new_column_name and new_column_name.strip():
                    if new_column_name not in ['ìœ„ì¹˜', 'ì„¤ê³„']:  # ê¸°ë³¸ ì—´ê³¼ ì¤‘ë³µ ë°©ì§€
                        st.session_state.custom_columns[new_column_name.strip()] = default_value if default_value else ""
                        st.success(f"'{new_column_name}' ì—´ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!")
                        st.rerun()
                    else:
                        st.error("'ìœ„ì¹˜'ì™€ 'ì„¤ê³„'ëŠ” ê¸°ë³¸ ì—´ëª…ì´ë¯€ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                else:
                    st.error("ì—´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        
        # í˜„ì¬ ì¶”ê°€ëœ ì—´ë“¤ í‘œì‹œ ë° ì‚­ì œ
        if st.session_state.custom_columns:
            st.write("**ì¶”ê°€ëœ ì—´ë“¤:**")
            for col_name, default_val in st.session_state.custom_columns.items():
                col_a, col_b = st.columns([3, 1])
                with col_a:
                    st.write(f"â€¢ {col_name}: {default_val}")
                with col_b:
                    if st.button(f"ì‚­ì œ", key=f"del_{col_name}"):
                        del st.session_state.custom_columns[col_name]
                        st.success(f"'{col_name}' ì—´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!")
                        st.rerun()

# ì›”ê°„ ëˆ„ê³„ ê³„ì‚° (Supabase ë°ì´í„°ì™€ ê²°í•©)
def calculate_monthly_cumulative(base_df, supabase_df):
    if supabase_df.empty:
        return base_df
    
    # ê²°ê³¼ ë°ì´í„°í”„ë ˆì„ ë³µì‚¬
    result_df = base_df.copy()
    
    # 25ë…„ê³¼ 26ë…„ì˜ ì›”ë³„ ë°ì´í„° ì²˜ë¦¬
    for year in [25, 26]:
        for month in range(1, 13):
            # í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œ ê³„ì‚°
            full_year = 2000 + year  # 2025, 2026
            last_day = calendar.monthrange(full_year, month)[1]
            month_end_date = date(full_year, month, last_day)
            
            # í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œê¹Œì§€ì˜ ë°ì´í„° í•„í„°ë§
            month_data = supabase_df[
                (supabase_df['ë‚ ì§œ'].dt.year == full_year) & 
                (supabase_df['ë‚ ì§œ'].dt.month == month)
            ]
            
            if not month_data.empty:
                # í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œ ë°ì´í„°ë§Œ ì‚¬ìš©
                last_date_data = month_data[month_data['ë‚ ì§œ'].dt.date <= month_end_date]
                if not last_date_data.empty:
                    # ê° ìœ„ì¹˜ë³„ë¡œ ëˆ„ê³„ê°’ ê³„ì‚°
                    for idx, row in result_df.iterrows():
                        location = row['ìœ„ì¹˜']
                        location_data = last_date_data[last_date_data['ìœ„ì¹˜'] == location]
                        
                        if not location_data.empty:
                            # ëˆ„ê³„ê°’ ê³„ì‚° (ì‹¤ì œ ì»¬ëŸ¼ëª…ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
                            cumulative = location_data['ì§„í–‰ë¥ '].sum() if 'ì§„í–‰ë¥ ' in location_data.columns else 0
                            # ì›”ë³„ ì»¬ëŸ¼ì— ê°’ ì„¤ì •
                            month_col = f"{year:02d}-{month:02d}"
                            result_df.at[idx, month_col] = cumulative
                        else:
                            # í•´ë‹¹ ìœ„ì¹˜ì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì„¤ì •
                            month_col = f"{year:02d}-{month:02d}"
                            result_df.at[idx, month_col] = 0
                else:
                    # í•´ë‹¹ ì›”ì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì„¤ì •
                    for idx in result_df.index:
                        month_col = f"{year:02d}-{month:02d}"
                        result_df.at[idx, month_col] = 0
            else:
                # í•´ë‹¹ ì›”ì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì„¤ì •
                for idx in result_df.index:
                    month_col = f"{year:02d}-{month:02d}"
                    result_df.at[idx, month_col] = 0
    
    # ê¸°ì¡´ ì›”ë³„ ëˆ„ê³„ ë° ëŒ€ë¹„ ê³„ì‚° (1ì›”ë¶€í„° 7ì›”ê¹Œì§€)
    current_year = 2025
    months = list(range(1, 8))
    
    for month in months:
        # í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œ ê³„ì‚°
        last_day = calendar.monthrange(current_year, month)[1]
        month_end_date = date(current_year, month, last_day)
        
        # í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œê¹Œì§€ì˜ ë°ì´í„° í•„í„°ë§
        month_data = supabase_df[
            (supabase_df['ë‚ ì§œ'].dt.year == current_year) & 
            (supabase_df['ë‚ ì§œ'].dt.month == month)
        ]
        
        if not month_data.empty:
            # í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œ ë°ì´í„°ë§Œ ì‚¬ìš©
            last_date_data = month_data[month_data['ë‚ ì§œ'].dt.date <= month_end_date]
            if not last_date_data.empty:
                # ê° ìœ„ì¹˜ë³„ë¡œ ëˆ„ê³„ê°’ ê³„ì‚°
                for idx, row in result_df.iterrows():
                    location = row['ìœ„ì¹˜']
                    location_data = last_date_data[last_date_data['ìœ„ì¹˜'] == location]
                    
                    if not location_data.empty:
                        # ëˆ„ê³„ê°’ ê³„ì‚° (ì‹¤ì œ ì»¬ëŸ¼ëª…ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
                        cumulative = location_data['ì§„í–‰ë¥ '].sum() if 'ì§„í–‰ë¥ ' in location_data.columns else 0
                        # ëŒ€ë¹„ê°’ ê³„ì‚° (ì„¤ê³„ê°’ ëŒ€ë¹„)
                        design_value = 100  # ì‹¤ì œ ì„¤ê³„ê°’ìœ¼ë¡œ ëŒ€ì²´ í•„ìš”
                        comparison = cumulative - design_value
                    else:
                        cumulative = 0
                        comparison = 0
                    
                    result_df.at[idx, f'{month:02d}ì›”_ëˆ„ê³„'] = cumulative
                    result_df.at[idx, f'{month:02d}ì›”_ëŒ€ë¹„'] = comparison
            else:
                # í•´ë‹¹ ì›”ì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì„¤ì •
                for idx in result_df.index:
                    result_df.at[idx, f'{month:02d}ì›”_ëˆ„ê³„'] = 0
                    result_df.at[idx, f'{month:02d}ì›”_ëŒ€ë¹„'] = 0
        else:
            # í•´ë‹¹ ì›”ì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì„¤ì •
            for idx in result_df.index:
                result_df.at[idx, f'{month:02d}ì›”_ëˆ„ê³„'] = 0
                result_df.at[idx, f'{month:02d}ì›”_ëŒ€ë¹„'] = 0
    
    return result_df

# AgGrid ì„¤ì • í•¨ìˆ˜
def configure_aggrid(df, title, height=400, is_base_table=False):
    gb = GridOptionsBuilder.from_dataframe(df)
    
    # ê¸°ë³¸ ì„¤ì •
    gb.configure_default_column(
        resizable=True,
        filterable=True,
        sortable=True,
        editable=False
    )
    
    # ê³ ì •ì—´ ì„¤ì • (í¸ì§‘ ë¶ˆê°€)
    fixed_columns = ["ìœ„ì¹˜", "ì „ì²´", "ëˆ„ê³„", "ì§„ë„ìœ¨", "ì”ì—¬"]
    
    # ìœ„ì¹˜ ì»¬ëŸ¼ ì„¤ì • (ë„“ê²Œ, í¸ì§‘ ë¶ˆê°€)
    gb.configure_column("ìœ„ì¹˜", width=350, pinned="left", editable=False)
    
    # ì„¤ê³„ ì»¬ëŸ¼ ì„¤ì • (í¸ì§‘ ê°€ëŠ¥)
    gb.configure_column("ì„¤ê³„", width=150, pinned="left", editable=True, 
                       type=['textColumn', 'textColumnFilter'])
    
    # ì‚¬ìš©ì ì •ì˜ ì—´ë“¤ ì„¤ì • (í¸ì§‘ ê°€ëŠ¥)
    if 'custom_columns' in st.session_state:
        for col_name in st.session_state.custom_columns.keys():
            gb.configure_column(col_name, 
                               width=150,
                               type=['textColumn', 'textColumnFilter'],
                               editable=True)
    
    # ê³ ì •ì—´ë“¤ ì„¤ì • (í¸ì§‘ ë¶ˆê°€)
    for col in fixed_columns:
        if col in df.columns:
            if col == "ìœ„ì¹˜":
                continue  # ì´ë¯¸ ì„¤ì •ë¨
            elif col == "ì „ì²´":
                gb.configure_column(col, width=150, editable=False)
            elif col == "ëˆ„ê³„":
                gb.configure_column(col, width=150, editable=False)
            elif col == "ì§„ë„ìœ¨":
                gb.configure_column(col, width=150, editable=False)
            elif col == "ì”ì—¬":
                gb.configure_column(col, width=150, editable=False)
    
    # ì›”ë³„ ì»¬ëŸ¼ë“¤ ì„¤ì • (25-01ë¶€í„° 26-12ê¹Œì§€, í¸ì§‘ ë¶ˆê°€)
    for year in [25, 26]:
        for month in range(1, 13):
            month_col = f"{year:02d}-{month:02d}"
            if month_col in df.columns:
                gb.configure_column(month_col, 
                                   header_name=f"{year:02d}-{month:02d}",
                                   width=150,
                                   type=['numericColumn', 'numberColumnFilter'],
                                   valueFormatter="value.toFixed(2)",
                                   editable=False)
    
    # ê¸°ë³¸ í…Œì´ë¸”ì´ ì•„ë‹Œ ê²½ìš° (ì›”ê°„ ëˆ„ê³„ í…Œì´ë¸”) ê¸°ì¡´ ì›”ë³„ ì»¬ëŸ¼ë“¤ë„ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
    if not is_base_table:
        # ê¸°ì¡´ ì›”ë³„ ì»¬ëŸ¼ë“¤ ì„¤ì • (í¸ì§‘ ê°€ëŠ¥)
        for month in range(1, 8):
            month_str = f'{month:02d}ì›”'
            if f'{month_str}_ëˆ„ê³„' in df.columns:
                gb.configure_column(f'{month_str}_ëˆ„ê³„', 
                                   header_name=f'{month_str} ëˆ„ê³„',
                                   width=150,
                                   type=['numericColumn', 'numberColumnFilter'],
                                   valueFormatter="value.toFixed(2)",
                                   editable=True)
            if f'{month_str}_ëŒ€ë¹„' in df.columns:
                gb.configure_column(f'{month_str}_ëŒ€ë¹„', 
                                   header_name=f'{month_str} ëŒ€ë¹„',
                                   width=150,
                                   type=['numericColumn', 'numberColumnFilter'],
                                   valueFormatter="value.toFixed(2)",
                                   editable=True)
    else:
        # ê¸°ë³¸ í…Œì´ë¸”ì¸ ê²½ìš° ê¸°ì¡´ ì›”ë³„ ì»¬ëŸ¼ë“¤ ì„¤ì • (í¸ì§‘ ë¶ˆê°€)
        for month in range(1, 8):
            month_str = f'{month:02d}ì›”'
            if f'{month_str}_ëˆ„ê³„' in df.columns:
                gb.configure_column(f'{month_str}_ëˆ„ê³„', 
                                   header_name=f'{month_str} ëˆ„ê³„',
                                   width=150,
                                   type=['numericColumn', 'numberColumnFilter'],
                                   valueFormatter="value.toFixed(2)",
                                   editable=False)
            if f'{month_str}_ëŒ€ë¹„' in df.columns:
                gb.configure_column(f'{month_str}_ëŒ€ë¹„', 
                                   header_name=f'{month_str} ëŒ€ë¹„',
                                   width=150,
                                   type=['numericColumn', 'numberColumnFilter'],
                                   valueFormatter="value.toFixed(2)",
                                   editable=False)
    
    # ê·¸ë¦¬ë“œ ì˜µì…˜ ì„¤ì •
    gb.configure_grid_options(
        domLayout='normal',
        rowHeight=35,
        headerHeight=50,
        suppressRowClickSelection=True,
        enableRangeSelection=True,
        rowSelection='multiple',
        suppressHorizontalScroll=False,  # ê°€ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™”
        suppressColumnVirtualisation=False,  # ì—´ ê°€ìƒí™” ë¹„í™œì„±í™”í•˜ì—¬ ëª¨ë“  ì—´ì´ ë Œë”ë§ë˜ë„ë¡ í•¨
        # ë“œë˜ê·¸ ë³µì‚¬ ê¸°ëŠ¥ì„ ìœ„í•œ ì¶”ê°€ ì„¤ì •
        allowRangeSelection=True,
        enableRangeHandle=True,
        enableFillHandle=True,
        suppressCopyRowsToClipboard=False,
        suppressCopySingleCellRanges=False,
        suppressPasteSingleCellRanges=False,
        suppressPasteMultipleCellRanges=False,
        # í´ë¦½ë³´ë“œ ë³µì‚¬ ì„¤ì •
        clipboardDelimiter='\t',  # íƒ­ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ Excel í˜¸í™˜ì„± í–¥ìƒ
        # ë“œë˜ê·¸ ì„ íƒ ì‹œ ì‹œê°ì  í”¼ë“œë°±
        enableCellTextSelection=True,
        suppressRowDeselection=False
    )
    
    # í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •
    gb.configure_pagination(
        enabled=True,
        paginationAutoPageSize=False,
        paginationPageSize=20
    )
    
    # ë„êµ¬ ëª¨ìŒ ì„¤ì •
    gb.configure_side_bar()
    
    grid_options = gb.build()
    
    # AgGrid ë Œë”ë§
    grid_response = AgGrid(
        df,
        grid_options=grid_options,
        data_return_mode=DataReturnMode.FILTERED_AND_SORTED,
        update_mode=GridUpdateMode.SELECTION_CHANGED,
        fit_columns_on_grid_load=False,  # ëª¨ë“  ì—´ì´ ì™„ì „íˆ ë³´ì´ë„ë¡ ì„¤ì •
        height=height,
        allow_unsafe_jscode=True,
        theme="streamlit",
        # ë“œë˜ê·¸ ë³µì‚¬ ê¸°ëŠ¥ì„ ìœ„í•œ JavaScript ì½”ë“œ
        js_code=JsCode("""
            // ê·¸ë¦¬ë“œ ì¤€ë¹„ ì™„ë£Œ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
            function onGridReady(params) {
                console.log('Grid is ready');
                
                // ë²”ìœ„ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                params.api.addEventListener('rangeSelectionChanged', function(event) {
                    console.log('Range selection changed:', event);
                });
                
                // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (Ctrl+C)
                params.api.addEventListener('keydown', function(event) {
                    if (event.ctrlKey && event.key === 'c') {
                        console.log('Ctrl+C pressed');
                        copySelectedRanges(params.api);
                    }
                });
                
                // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë“œë˜ê·¸ ë³µì‚¬)
                params.api.addEventListener('mouseup', function(event) {
                    console.log('Mouse up event:', event);
                });
            }
            
            // ì„ íƒëœ ë²”ìœ„ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í•˜ëŠ” í•¨ìˆ˜
            function copySelectedRanges(api) {
                try {
                    var selectedRanges = api.getCellRanges();
                    console.log('Selected ranges:', selectedRanges);
                    
                    if (selectedRanges && selectedRanges.length > 0) {
                        var data = [];
                        
                        selectedRanges.forEach(function(range) {
                            var rowData = [];
                            
                            for (var rowIndex = range.startRow.rowIndex; rowIndex <= range.endRow.rowIndex; rowIndex++) {
                                for (var colIndex = range.startColumn.colIndex; colIndex <= range.endColumn.colIndex; colIndex++) {
                                    var value = api.getValue(range.startColumn.colId, rowIndex);
                                    rowData.push(value || '');
                                }
                                data.push(rowData.join('\\t'));
                            }
                        });
                        
                        var text = data.join('\\n');
                        console.log('Data to copy:', text);
                        
                        // í´ë¦½ë³´ë“œì— ë³µì‚¬
                        navigator.clipboard.writeText(text).then(function() {
                            console.log('Data copied to clipboard successfully');
                        }).catch(function(err) {
                            console.error('Failed to copy to clipboard:', err);
                            // ëŒ€ì²´ ë°©ë²•: ì„ì‹œ textarea ì‚¬ìš©
                            fallbackCopyTextToClipboard(text);
                        });
                    }
                } catch (error) {
                    console.error('Error copying data:', error);
                }
            }
            
            // í´ë¦½ë³´ë“œ ë³µì‚¬ ëŒ€ì²´ ë°©ë²•
            function fallbackCopyTextToClipboard(text) {
                var textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    var successful = document.execCommand('copy');
                    if (successful) {
                        console.log('Data copied using fallback method');
                    }
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                }
                
                document.body.removeChild(textArea);
            }
            
            // ê·¸ë¦¬ë“œ ì¤€ë¹„ ì™„ë£Œ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            if (typeof onGridReady === 'function') {
                onGridReady(params);
            }
        """)
    )
    
    return grid_response

# ë©”ì¸ í˜ì´ì§€
st.title("ğŸ“Š ì›”ê°„ì‹¤ì  - Construction Status")

# ë“œë˜ê·¸ ë³µì‚¬ ê¸°ëŠ¥ ì•ˆë‚´
with st.expander("ğŸ“‹ ë“œë˜ê·¸ ë³µì‚¬ ê¸°ëŠ¥ ì‚¬ìš©ë²•", expanded=False):
    st.markdown("""
    **Excelê³¼ ê°™ì€ ë“œë˜ê·¸ ë³µì‚¬ ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!**
    
    **ì‚¬ìš© ë°©ë²•:**
    1. **ë§ˆìš°ìŠ¤ ë“œë˜ê·¸**: ì…€ì„ ë“œë˜ê·¸í•˜ì—¬ ë²”ìœ„ ì„ íƒ
    2. **Ctrl+C**: ì„ íƒëœ ë²”ìœ„ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬
    3. **Excelì— ë¶™ì—¬ë„£ê¸°**: ë³µì‚¬ëœ ë°ì´í„°ë¥¼ Excelì— ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥
    
    **ì§€ì› ê¸°ëŠ¥:**
    - ë‹¨ì¼ ì…€ ì„ íƒ ë° ë³µì‚¬
    - ì—¬ëŸ¬ ì…€ ë²”ìœ„ ì„ íƒ ë° ë³µì‚¬
    - í–‰/ì—´ ì „ì²´ ì„ íƒ ë° ë³µì‚¬
    - íƒ­ìœ¼ë¡œ êµ¬ë¶„ëœ ë°ì´í„° í˜•ì‹ (Excel í˜¸í™˜)
    
    **ë¬¸ì œ í•´ê²°:**
    - ë³µì‚¬ê°€ ì•ˆ ë  ë•Œ: ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬(F12)ì˜ Console íƒ­ì„ í™•ì¸í•´ì£¼ì„¸ìš”
    - ë“œë˜ê·¸ ì„ íƒì´ ì•ˆ ë  ë•Œ: ì…€ì„ í´ë¦­í•œ í›„ ë“œë˜ê·¸í•´ë³´ì„¸ìš”
    """)
    
    # ë””ë²„ê¹… ì •ë³´ í‘œì‹œ
    if st.button("ğŸ” ë“œë˜ê·¸ ë³µì‚¬ ìƒíƒœ í™•ì¸"):
        st.info("""
        **í˜„ì¬ ì„¤ì •ëœ ë“œë˜ê·¸ ë³µì‚¬ ì˜µì…˜:**
        - âœ… enableRangeSelection: True
        - âœ… allowRangeSelection: True
        - âœ… enableRangeHandle: True
        - âœ… enableFillHandle: True
        - âœ… suppressCopySingleCellRanges: False
        - âœ… clipboardDelimiter: íƒ­(\\t)
        
        **JavaScript ê¸°ëŠ¥:**
        - âœ… ê·¸ë¦¬ë“œ ì¤€ë¹„ ì™„ë£Œ ì´ë²¤íŠ¸
        - âœ… ë²”ìœ„ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
        - âœ… Ctrl+C í‚¤ë³´ë“œ ì´ë²¤íŠ¸
        - âœ… í´ë¦½ë³´ë“œ ë³µì‚¬ (navigator.clipboard)
        - âœ… ëŒ€ì²´ ë³µì‚¬ ë°©ë²• (document.execCommand)
        """)

# ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
col1, col2, col3 = st.columns([1, 2, 1])
with col2:
    if st.button("ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨", use_container_width=True):
        st.cache_data.clear()
        st.rerun()

# Supabase ì—°ê²° í…ŒìŠ¤íŠ¸
with st.expander("ğŸ”Œ Supabase ì—°ê²° í…ŒìŠ¤íŠ¸", expanded=False):
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("ğŸ”— ì—°ê²° í…ŒìŠ¤íŠ¸"):
            try:
                supabase = init_supabase()
                if supabase:
                    st.success("âœ… Supabase ì—°ê²° ì„±ê³µ!")
                    
                    # í…Œì´ë¸” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    try:
                        response = supabase.table('information_schema.tables').select('table_name').eq('table_schema', 'public').execute()
                        if response.data:
                            tables = [item['table_name'] for item in response.data]
                            st.info(f"ì‚¬ìš© ê°€ëŠ¥í•œ í…Œì´ë¸”: {', '.join(tables)}")
                        else:
                            st.warning("í…Œì´ë¸” ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    except Exception as e:
                        st.error(f"í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜: {str(e)}")
                else:
                    st.error("âŒ Supabase ì—°ê²° ì‹¤íŒ¨!")
            except Exception as e:
                st.error(f"âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: {str(e)}")
    
    with col2:
        if st.button("ğŸ“Š construction_status í…Œì´ë¸” êµ¬ì¡° í™•ì¸"):
            try:
                supabase = init_supabase()
                if supabase:
                    # í…Œì´ë¸” êµ¬ì¡° í™•ì¸
                    response = supabase.table('construction_status').select('*').limit(1).execute()
                    if response.data:
                        st.success("âœ… construction_status í…Œì´ë¸” ì ‘ê·¼ ì„±ê³µ!")
                        st.json(response.data[0])  # ì²« ë²ˆì§¸ í–‰ í‘œì‹œ
                    else:
                        st.warning("construction_status í…Œì´ë¸”ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                else:
                    st.error("Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.")
            except Exception as e:
                st.error(f"í…Œì´ë¸” êµ¬ì¡° í™•ì¸ ì˜¤ë¥˜: {str(e)}")

# ì‚¬ìš© ê°€ëŠ¥í•œ í…Œì´ë¸” í™•ì¸
with st.spinner("ì‚¬ìš© ê°€ëŠ¥í•œ í…Œì´ë¸”ì„ í™•ì¸í•˜ëŠ” ì¤‘..."):
    available_tables = get_available_tables()

if available_tables:
    st.success(f"âœ… ì‚¬ìš© ê°€ëŠ¥í•œ í…Œì´ë¸”: {', '.join(available_tables)}")
    
    # construction_status í…Œì´ë¸”ì´ ìˆëŠ”ì§€ í™•ì¸
    if 'construction_status' in available_tables:
        st.success("ğŸ¯ construction_status í…Œì´ë¸”ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!")
    else:
        st.warning("âš ï¸ construction_status í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        st.info("ì‚¬ìš© ê°€ëŠ¥í•œ í…Œì´ë¸” ì¤‘ì—ì„œ ì„ íƒí•˜ì—¬ ë°ì´í„°ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.")
    
    # í…Œì´ë¸” ì„ íƒ (ë””ë²„ê¹…ìš©)
    with st.expander("ğŸ” í…Œì´ë¸” ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°", expanded=False):
        selected_table = st.selectbox(
            "ë¯¸ë¦¬ë³´ê¸°í•  í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”:",
            available_tables,
            index=available_tables.index('construction_status') if 'construction_status' in available_tables else 0
        )
        
        if st.button(f"ğŸ“Š {selected_table} í…Œì´ë¸” ë¯¸ë¦¬ë³´ê¸°"):
            with st.spinner(f"{selected_table} í…Œì´ë¸”ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."):
                try:
                    supabase = init_supabase()
                    if supabase:
                        response = supabase.table(selected_table).select('*').limit(5).execute()
                        if response.data:
                            st.success(f"âœ… {selected_table} í…Œì´ë¸”ì—ì„œ {len(response.data)} ê±´ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.")
                            st.json(response.data)  # ì²˜ìŒ 5ê°œ í–‰ í‘œì‹œ
                        else:
                            st.warning(f"{selected_table} í…Œì´ë¸”ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                except Exception as e:
                    st.error(f"í…Œì´ë¸” ì ‘ê·¼ ì˜¤ë¥˜: {str(e)}")
else:
    st.warning("âš ï¸ ì‚¬ìš© ê°€ëŠ¥í•œ í…Œì´ë¸”ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    st.info("Supabase ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")

# í•­ìƒ ë³´ì—¬ì§€ëŠ” ê¸°ë³¸ í…Œì´ë¸” ìƒì„±
st.subheader("ğŸ—ï¸ ì‹œê³µí˜„í™© ê¸°ë³¸ êµ¬ì¡°")

# ì‚¬ìš©ì ì •ì˜ ì—´ ì¶”ê°€ ê¸°ëŠ¥
add_custom_column()

st.markdown("---")

base_table = create_base_table()

# ê¸°ë³¸ í…Œì´ë¸”ì„ AgGridë¡œ í‘œì‹œ
grid_response_base = configure_aggrid(base_table, "ê¸°ë³¸ êµ¬ì¡°", height=1200, is_base_table=True)

# Supabaseì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
with st.spinner("construction_status í…Œì´ë¸”ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."):
    supabase_df = get_construction_status()

if supabase_df.empty:
    st.warning("âš ï¸ construction_status í…Œì´ë¸”ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    st.info("""
    **ê°€ëŠ¥í•œ ì›ì¸:**
    1. Supabase ì—°ê²° ë¬¸ì œ
    2. construction_status í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
    3. í…Œì´ë¸”ì— ë°ì´í„°ê°€ ì—†ìŒ
    4. ì ‘ê·¼ ê¶Œí•œ ë¬¸ì œ
    
    **í•´ê²° ë°©ë²•:**
    1. ìœ„ì˜ 'Supabase ì—°ê²° í…ŒìŠ¤íŠ¸' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì—°ê²° ìƒíƒœ í™•ì¸
    2. 'construction_status í…Œì´ë¸” êµ¬ì¡° í™•ì¸' ë²„íŠ¼ìœ¼ë¡œ í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    3. 'í…Œì´ë¸” ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°'ì—ì„œ ë‹¤ë¥¸ í…Œì´ë¸” í™•ì¸
    """)
else:
    st.success(f"âœ… construction_status í…Œì´ë¸”ì—ì„œ ì´ {len(supabase_df)} ê±´ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.")
    
    # ë°ì´í„° êµ¬ì¡° ì •ë³´ í‘œì‹œ
    with st.expander("ğŸ“‹ ë°ì´í„° êµ¬ì¡° ì •ë³´", expanded=False):
        st.write(f"**ì»¬ëŸ¼ ìˆ˜:** {len(supabase_df.columns)}")
        st.write(f"**í–‰ ìˆ˜:** {len(supabase_df)}")
        st.write(f"**ì»¬ëŸ¼ëª…:** {list(supabase_df.columns)}")
        st.write(f"**ë°ì´í„° íƒ€ì…:**")
        st.write(supabase_df.dtypes)
    
    # ì›”ê°„ ëˆ„ê³„ ê³„ì‚° (ê¸°ë³¸ í…Œì´ë¸” + Supabase ë°ì´í„°)
    try:
        monthly_df = calculate_monthly_cumulative(base_table, supabase_df)
        
        if not monthly_df.empty:
            # í…Œì´ë¸” í‘œì‹œ
            st.subheader("ğŸ—ï¸ ì‹œê³µí˜„í™© ì›”ê°„ ëˆ„ê³„")
            
            # ì»¬ëŸ¼ëª… ì •ë¦¬ (ê³ ì •ì—´ í¬í•¨)
            display_columns = ['ìœ„ì¹˜', 'ì„¤ê³„', 'ì „ì²´', 'ëˆ„ê³„', 'ì§„ë„ìœ¨', 'ì”ì—¬']
            
            # ì‚¬ìš©ì ì •ì˜ ì—´ë“¤ ì¶”ê°€
            if 'custom_columns' in st.session_state:
                display_columns.extend(list(st.session_state.custom_columns.keys()))
            
            # 25-01ë¶€í„° 26-12ê¹Œì§€ì˜ ì›”ë³„ ì»¬ëŸ¼ë“¤ ì¶”ê°€ (ê³ ì •ì—´)
            for year in [25, 26]:
                for month in range(1, 13):
                    month_col = f"{year:02d}-{month:02d}"
                    display_columns.append(month_col)
            
            # ê¸°ì¡´ ì›”ë³„ ëˆ„ê³„ ë° ëŒ€ë¹„ ì»¬ëŸ¼ë“¤ ì¶”ê°€
            for month in range(1, 8):
                display_columns.extend([f'{month:02d}ì›”_ëˆ„ê³„', f'{month:02d}ì›”_ëŒ€ë¹„'])
            
            # ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ë§Œ í•„í„°ë§
            available_columns = [col for col in display_columns if col in monthly_df.columns]
            missing_columns = [col for col in display_columns if col not in monthly_df.columns]
            
            if missing_columns:
                st.warning(f"âš ï¸ ì¼ë¶€ ì»¬ëŸ¼ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: {missing_columns}")
            
            # ì›”ê°„ ëˆ„ê³„ ë°ì´í„°ë¥¼ AgGridë¡œ í‘œì‹œ
            monthly_display_df = monthly_df[available_columns].copy()
            
            # ìˆ«ì ì»¬ëŸ¼ë“¤ì„ floatë¡œ ë³€í™˜
            for col in monthly_display_df.columns:
                if col not in ['ìœ„ì¹˜', 'ì„¤ê³„']:
                    monthly_display_df[col] = pd.to_numeric(monthly_display_df[col], errors='coerce').fillna(0)
            
            grid_response_monthly = configure_aggrid(monthly_display_df, "ì›”ê°„ ëˆ„ê³„", height=1200, is_base_table=False)
            
            # ë°ì´í„° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
            col1, col2, col3 = st.columns([1, 2, 1])
            with col2:
                csv = monthly_df.to_csv(index=False, encoding='utf-8-sig')
                st.download_button(
                    label="ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ",
                    data=csv,
                    file_name=f"ì‹œê³µí˜„í™©_ì›”ê°„ëˆ„ê³„_{datetime.now().strftime('%Y%m%d')}.csv",
                    mime="text/csv",
                    use_container_width=True
                )
        else:
            st.error("âŒ ì›”ê°„ ëˆ„ê³„ ë°ì´í„°ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    except Exception as e:
        st.error(f"âŒ ì›”ê°„ ëˆ„ê³„ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
        st.info("ë°ì´í„° êµ¬ì¡°ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")

# ì‚¬ì´ë“œë°”
st.sidebar.title("ğŸ“‹ ë©”ë‰´")
if st.sidebar.button("ğŸ  ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°"):
    st.switch_page("main.py")

# í•˜ë‹¨ ì •ë³´
st.markdown("---")
st.markdown("*ì´ í˜ì´ì§€ëŠ” í•­ìƒ ë³´ì—¬ì§€ëŠ” ê¸°ë³¸ í…Œì´ë¸”ê³¼ Supabaseì˜ construction_status í…Œì´ë¸”ì—ì„œ ì›”ê°„ ëˆ„ê³„ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.*")
