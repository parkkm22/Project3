import streamlit as st
import re
import requests
import json
import pandas as pd

# --- CONSTANTS & API SETUP ---
# Gemini API ì„¤ì •ì€ ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼í•˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤.
API_KEY = "AIzaSyD69-wKYfZSID327fczrkx-JveJdGYIUIk"
API_ENDPOINT = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key={API_KEY}"

# --- SESSION STATE ---
def initialize_report_session_state():
    """í˜ì´ì§€ 1ì˜ ì„¸ì…˜ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤."""
    if 'PROMPT_PAGE1' not in st.session_state:
        st.session_state.PROMPT_PAGE1 = """
# INSTRUCTIONS
1. ì¶œë ¥ì€ ì½”ë“œë¸”ëŸ­ìœ¼ë¡œ ê°ì‹¸ê³ , "MAIN SET" ì–‘ì‹ì„ ìœ ì§€í•˜ì—¬ ì‘ì„±í•  ê²ƒ
2. ì…ë ¥ëœ USER TEXT 3ê°œ í•­ëª©ì„ ê¸°ë°˜ìœ¼ë¡œ "MAIN SET"ì˜ ê° ìœ„ì¹˜ì— ë§ëŠ” ë‚´ìš©ë§Œ ì±„ì›Œì„œ í•˜ë‚˜ì˜ ë³´ê³ ì„œë¡œ ì·¨í•©í•  ê²ƒ
3. ì‘ì—… ìœ„ì¹˜ëŠ” ì•„ë˜ ìˆœì„œì— ë”°ë¼ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•˜ê³ , ìˆ«ì ë²ˆí˜¸(ì˜ˆ: 1), 2))ë¡œ êµ¬ë¶„ëœ ì„¹ì…˜ì€ ì„œë¡œ ì™„ì „íˆ ë…ë¦½ëœ ë‚´ìš©ìœ¼ë¡œ ì·¨ê¸‰ 
   - 1. ë³¸ì„ í„°ë„(1êµ¬ê°„)
   - 2. ì‹ í’ì •ê±°ì¥
   - 3. ì‹ í’ì •ê±°ì¥ í™˜ìŠ¹í†µë¡œ
   - 4. ë³¸ì„ í„°ë„(2êµ¬ê°„)
   - 5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥
4. ë‚ ì§œëŠ” USER TEXTì— ëª…ì‹œëœ ë‚ ì§œ ì¤‘ ì²« ë²ˆì§¸ í•­ëª© ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±
5. "â€» ì•ˆì „ê´€ë¦¬ ì¤‘ì  POINT"ëŠ” ì¤‘ë³µ ì—†ì´ 10ê°œ ì´í•˜ í•­ëª©ì„ ì¶”ì¶œí•˜ì—¬ ë§¨ í•˜ë‹¨ì— 1íšŒë§Œ ì‘ì„±
6. "â–  ì´ ì¸ì›" ë° "â–  ì´ ì¥ë¹„" í•­ëª©ì€ ì „ì²´ íˆ¬ì…ì¸ì› ë° ì¥ë¹„ë¥¼ ë‹¨ìˆœ í•©ì‚°í•˜ì—¬ ì‘ì„±í•˜ë©°, ìœ„ì¹˜ë³„ ê³µì¢… êµ¬ë¶„ ì—†ì´ ì „ì²´ ìˆ˜ëŸ‰ë§Œ ì‘ì„±
7. QA-CHECKLIST(ìë™ ê²€ì¦ í›„ ë³€í™˜ë¡œê·¸ ì¶œë ¥)
- ë§¤í•‘ ëˆ„ë½ ì—¬ë¶€: USER TEXT ë‚´ ë‹¨ì–´ ì¤‘ ë§¤í•‘ë˜ì§€ ì•Šì€ í•­ëª© í™•ì¸
- ë³€í™˜ë¡œê·¸: ê° USER TEXT(USER TEXT 1, USER TEXT 2, USER TEXT 3)ë³„ë¡œ êµ¬ë¶„í•˜ì—¬, ì–´ë–¤ USER TEXTì—ì„œ ë³€ê²½ì´ ë°œìƒí–ˆëŠ”ì§€ ì‹ë³„ìì™€ í•¨ê»˜ ë³€ê²½ëœ [ì›ë¬¸] ë° [ê²°ê³¼]ë¥¼ ë‹¤ìŒ Markdown í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•œë‹¤.

  `USER TEXT 1 ë³€ê²½ì‚¬í•­:`
  | ì›ë¬¸ | ê²°ê³¼ |
  |---|---|
  | ì˜ˆì‹œ ì›ë¬¸1 | ì˜ˆì‹œ ê²°ê³¼1 |

  `USER TEXT 2 ë³€ê²½ì‚¬í•­:`
  | ì›ë¬¸ | ê²°ê³¼ |
  |---|---|
  | ì˜ˆì‹œ ì›ë¬¸3 | ì˜ˆì‹œ ê²°ê³¼3 |

  `USER TEXT 3 ë³€ê²½ì‚¬í•­:`
  | ì›ë¬¸ | ê²°ê³¼ |
  |---|---|
  | ì˜ˆì‹œ ì›ë¬¸4 | ì˜ˆì‹œ ê²°ê³¼4 |

- ë§Œì•½ íŠ¹ì • USER TEXTì—ì„œ ë³€ê²½ì‚¬í•­ì´ ì—†ë‹¤ë©´, í•´ë‹¹ ì„¹ì…˜ì— "| ë³€ê²½ì‚¬í•­ ì—†ìŒ | - |" ë¡œ í‘œê¸°í•œë‹¤.
- ì „ì²´ì ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ì´ ì „í˜€ ì—†ë‹¤ë©´, "ëª¨ë“  USER TEXTì—ì„œ ë³€ê²½ì‚¬í•­ ì—†ìŒ"ìœ¼ë¡œ í‘œê¸°í•œë‹¤.

# Mapping Rules
1. ì¸ì› 
- í‘œê¸° ìˆœì„œ: â‘ ì§ì˜ë°˜ì¥ â†’ â‘¡ëª©ê³µ â†’ â‘¢ì² ê·¼ê³µ â†’ â‘£ì—°ìˆ˜ìƒ â†’ â‘¤ì‹ í˜¸ìˆ˜ â†’ â‘¥ê·¸ ì™¸
- "ì§ì˜"ì€ ì—°ìˆ˜ìƒì— í•©ì‚° (ë‹¨, ì§ì˜ë°˜ì¥ì€ ë³„ë„ í‘œê¸°)
- "0ëª…", "-ëª…" ë“±ì€ ì œì™¸í•˜ê³ , ì¸ì› í•­ëª©ì´ ì—†ì„ ê²½ìš° "ì—†ìŒ"ìœ¼ë¡œ í‘œê¸°
- ì¸ì›ì€ ìŠ¬ë˜ì‹œ(/)ë¡œ êµ¬ë¶„
- '/ ì•ë’¤ì— ê³µë°±ì´ ìˆë“  ì—†ë“  ë¬´ê´€í•˜ë©°, ë‘˜ ë‹¤ ì •ìƒì ìœ¼ë¡œ ì¸ì‹ ë° í•©ì‚°ë¨'
-"ì§ì˜"ì€ ì—°ìˆ˜ìƒì— í¬í•¨í•˜ì—¬ ê³„ì‚°
2. ì¥ë¹„
- ""0ëŒ€", "-ëŒ€" ë“±ì€ ì œì™¸í•˜ê³ , ì¥ë¹„ í•­ëª©ì´ ì—†ì„ ê²½ìš° "ì—†ìŒ"ìœ¼ë¡œ í‘œê¸°
- ë„ì–´ì“°ê¸°, ëŒ€ì†Œë¬¸ì, ê´„í˜¸ ë“± ì˜¤íƒ€ ê°€ëŠ¥ì„±ì„ ê°ì•ˆí•˜ì—¬ ë§¤í•‘
- ì¥ë¹„ëŠ” ìŠ¬ë˜ì‹œ(/)ë¡œ êµ¬ë¶„
- '/ ì•ë’¤ì— ê³µë°±ì´ ìˆë“  ì—†ë“  ë¬´ê´€í•˜ë©°, ë‘˜ ë‹¤ ì •ìƒì ìœ¼ë¡œ ì¸ì‹ ë° í•©ì‚°ë¨'
3. â€» ì•ˆì „ê´€ë¦¬ ì¤‘ì  POINT (ë§¤ìš° ì¤‘ìš”: ë°˜ë“œì‹œ 10ê°œ ì´í•˜ë¡œ ì œí•œ)
- ê° ì…ë ¥ì˜ í•˜ë‹¨ì—ì„œ "5ëŒ€ ì•ˆì „ì‚¬ê³ (ì¶”ë½, í˜‘ì°©, ë‚™í•˜, ì§ˆì‹, í­ë°œ)"ì™€ ê´€ë ¨ ìˆëŠ” ë¬¸ì¥ ì¤‘ ì •í™•íˆ ìµœëŒ€ 10ê°œë§Œ ì„ íƒí•˜ì—¬ ì¶œë ¥
- ì ˆëŒ€ë¡œ 10ê°œë¥¼ ì´ˆê³¼í•˜ì§€ ë§ ê²ƒ. 11ê°œ ì´ìƒ ì¶œë ¥ ì‹œ ì˜¤ë¥˜ë¡œ ê°„ì£¼
- ì¤‘ë³µ í•­ëª© ì œê±° í›„ ì¶œë ¥
- ìˆœì„œëŠ” ì¶”ì¶œëœ ìˆœì„œë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€
- ë§Œì•½ ì¶”ì¶œëœ í•­ëª©ì´ 10ê°œë¥¼ ë„˜ëŠ”ë‹¤ë©´ ê°€ì¥ ì¤‘ìš”í•œ 10ê°œë§Œ ì„ íƒí•˜ì—¬ ì¶œë ¥
4. "ì´ ì¸ì›" ë° "ì´ ì¥ë¹„" ê³„ì‚° ì§€ì¹¨ (ë§¤ìš° ì¤‘ìš”, ë°˜ë“œì‹œ ì •í™•í•˜ê²Œ ìˆ˜í–‰í•  ê²ƒ):
- ëª©í‘œ: USER TEXT 1, USER TEXT 2, USER TEXT 3 ì „ì²´ì— ê±¸ì³ ì–¸ê¸‰ëœ ëª¨ë“  ì¸ì›ìˆ˜ì™€ ì¥ë¹„ìˆ˜ë¥¼ ì •í™•íˆ í•©ì‚°í•œë‹¤.
- ì¸ì› í•©ì‚°:
    a. USER TEXT 1, 2, 3ì—ì„œ 'ìˆ«ì+ëª…' íŒ¨í„´ì„ ëª¨ë‘ ì°¾ëŠ”ë‹¤. (ì˜ˆ: "ëª©ê³µ 5ëª…", "ì¸ë¶€ 10ëª…")
    b. 'ì§ì˜ë°˜ì¥'ìœ¼ë¡œ ëª…ì‹œëœ ì¸ì›ì€ í•©ì‚°ì—ì„œ ì œì™¸í•œë‹¤. '0ëª…', '-ëª…', 'ì—†ìŒ' ë“± ìˆ˜ì¹˜ê°€ ì—†ëŠ” í•­ëª©ë„ ì œì™¸í•œë‹¤.
    c. ìœ„ì—ì„œ ì°¾ì€ ëª¨ë“  ìœ íš¨ ì¸ì›ìˆ˜ë¥¼ ë”í•˜ì—¬ 'ì´ ì¸ì›'ì„ ê³„ì‚°í•œë‹¤.
- ì¥ë¹„ í•©ì‚°:
    a. USER TEXT 1, 2, 3ì—ì„œ 'ìˆ«ì+ëŒ€' íŒ¨í„´ì„ ëª¨ë‘ ì°¾ëŠ”ë‹¤. (ì˜ˆ: "êµ´ì‚­ê¸° 2ëŒ€", "ë¤í”„ 5ëŒ€")
    b. '0ëŒ€', '-ëŒ€', 'ì—†ìŒ' ë“± ìˆ˜ì¹˜ê°€ ì—†ëŠ” í•­ëª©ì€ ì œì™¸í•œë‹¤.
    c. ìœ„ì—ì„œ ì°¾ì€ ëª¨ë“  ìœ íš¨ ì¥ë¹„ìˆ˜ë¥¼ ë”í•˜ì—¬ 'ì´ ì¥ë¹„'ë¥¼ ê³„ì‚°í•œë‹¤.
- ìµœì¢… ê²€ì¦: ê³„ì‚°ëœ 'ì´ ì¸ì›'ê³¼ 'ì´ ì¥ë¹„'ê°€ ì…ë ¥ëœ ëª¨ë“  ê°œë³„ ìˆ˜ì¹˜ë“¤ì˜ ì‹¤ì œ ì´í•©ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•œë‹¤.
- ì¶œë ¥ í˜•ì‹: ìµœì¢… ê²°ê³¼ëŠ” "â–  ì´ ì¸ì› : [ê³„ì‚°ëœ ì´ ì¸ì›ìˆ˜]ëª…", "â–  ì´ ì¥ë¹„ : [ê³„ì‚°ëœ ì´ ì¥ë¹„ìˆ˜]ëŒ€" í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•œë‹¤. ì ˆëŒ€ë¡œ '##ëª…' ë˜ëŠ” '##ëŒ€'ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
5. íƒ€ì„¤ ê´€ë ¨ ê·œì¹™
- "â–  ì‘ì—…ë‚´ìš©"ì— "íƒ€ì„¤"ì´ë¼ëŠ” ë‹¨ì–´ê°€ í¬í•¨ë˜ë©´ "Con'c íƒ€ì„¤"ë¡œ ìë™ ì¹˜í™˜
6. ë§¤í•‘ ë”•ì…”ë„ˆë¦¬ ì ìš©  
- "ì¥ë¹„ëª…"+"(ê·œê²©)"
   ì˜ˆì‹œ:
   ì•µê¸€í¬ë ˆì¸ 35T â†’ ì•µê¸€í¬ë ˆì¸(35T), b/h08lc â†’ B/H(08LC)
-"B/H08W" â†’ "B/H(08W)"
-"ë°±í˜¸06W"â†’ "B/H(06W)"
-"25í†¤ ì¹´ê³ í¬ë ˆì¸" â†’ "ì¹´ê³ í¬ë ˆì¸(25T)"
-"í¬ë ˆì¸(25T)" â†’ "ì¹´ê³ í¬ë ˆì¸(25T)"
-"ê¸°ê³„íƒ€ì„¤ê³µ" â†’ "íƒ€ì„¤ê³µ"    
-"ì² ê·¼ì—°ìˆ˜ìƒ" ë˜ëŠ” "ëª©ê³µì—°ìˆ˜ìƒ" â†’ "ì—°ìˆ˜ìƒ"    
-"5í†¤íŠ¸ëŸ­" â†’ "í™”ë¬¼ì°¨(5T)"    
-"ì¹´ë¦¬í”„íŠ¸" â†’ "ì¹´ë¦¬í”„íŠ¸ê³µ"    
-"20í†¤í¬ë ˆì¸" â†’ "í•˜ì´ë“œë¡œí¬ë ˆì¸(20T)"    
-"ë¼ì´ë‹í¼ì¡°ë¦½" â†’ "ë¼ì´ë‹í¼ê³µ"    
-"S/Cíƒ€ì„¤íŒ€" â†’ "í„°ë„ê³µ"    
-"ëª©ìˆ˜" â†’ "ëª©ê³µ"    
- ì‚¬ì „ì— ì—†ëŠ” í•­ëª© â†’ ìœ ì‚¬í•­ëª©ìœ¼ë¡œ ì¶”ì¶œ

# MAIN SET(ì¶œë ¥ì˜ˆì‹œ)
ì‹ ì•ˆì‚°ì„  4-1ê³µêµ¬(í¬ìŠ¤ì½”ì´ì•¤ì”¨)
2025ë…„ 00ì›” 00ì¼(0) ì‘ì—…ê³„íšë³´ê³ 

1.ë³¸ì„ í„°ë„(1êµ¬ê°„, ëŒ€ë¦¼-ì‹ í’)
â– ì‘ì—…ë‚´ìš©
- 
â– ì‹œê³µí˜„í™©(ëˆ„ê³„/ì„¤ê³„)
- 
â–  íˆ¬ì…í˜„í™© (ì£¼ê°„)
- ì¸ì› :
- ì¥ë¹„ :

2.ì‹ í’ì •ê±°ì¥
 1) ì •ê±°ì¥ í„°ë„
 â–  ì‘ì—…ë‚´ìš©
 - 
 â–  ì‹œê³µí˜„í™©(ëˆ„ê³„/ì„¤ê³„)
 - 
 â–  íˆ¬ì…í˜„í™© (ì£¼ê°„)
 - ì¸ì› : 
 - ì¥ë¹„ : 

 2) ì£¼ì¶œì…êµ¬ ì—°ê²°í„°ë„
  (1) PCB
  â–  ì‘ì—…ë‚´ìš©
 - PCB(ì •í™”ì¡° ë°©ë©´) : 
 - PCB(ì •ê±°ì¥ ë°©ë©´) : 
 - PCB(í™˜ìŠ¹í†µë¡œ ë°©ë©´) : 
  â–  ì‹œê³µí˜„í™©(ëˆ„ê³„/ì„¤ê³„)
 - ì •ê±°ì¥ ë°©ë©´
   ã„´ 
 - í™˜ìŠ¹í†µë¡œ ë°©ë©´
   ã„´ 
  â–  íˆ¬ì…í˜„í™© (ì£¼ê°„)
 - ì¸ì› : 
 - ì¥ë¹„ : 

 (2) PCC
  â–  ì‘ì—…ë‚´ìš©
 - 
  â–  ì‹œê³µí˜„í™©(ëˆ„ê³„/ì„¤ê³„)
   ã„´ 
  â–  íˆ¬ì…í˜„í™© (ì£¼ê°„)
   - ì¸ì› : 
   - ì¥ë¹„ : 

 (3) PCD(í™˜ìŠ¹í†µë¡œ M/Wêµ¬ê°„)
  â–  ì‘ì—…ë‚´ìš©
 - 
  â–  ì‹œê³µí˜„í™©(ëˆ„ê³„/ì„¤ê³„)
   ã„´ 
  â–  íˆ¬ì…í˜„í™© (ì£¼ê°„)
   - ì¸ì› : 
   - ì¥ë¹„ : 

 (4) PHA
  â–  ì‘ì—…ë‚´ìš©
 - 
  â–  ì‹œê³µí˜„í™©(ëˆ„ê³„/ì„¤ê³„)
   ã„´ 
  â–  íˆ¬ì…í˜„í™© (ì£¼ê°„)
   - ì¸ì› : 
   - ì¥ë¹„ : 

 3) íŠ¹ë³„í”¼ë‚œê³„ë‹¨
  â–  ì‘ì—…ë‚´ìš©
 - 
  â–  íˆ¬ì…í˜„í™© (ì£¼ê°„)
 - ì¸ì› : 
 - ì¥ë¹„ : 

 4) ì™¸ë¶€ì¶œì…êµ¬(#2)
  â–  ì‘ì—…ë‚´ìš©
 - 
  â–  ì‹œê³µí˜„í™©(ëˆ„ê³„/ì„¤ê³„)
 - 
  â–  íˆ¬ì…í˜„í™© (ì£¼ê°„)
 - ì¸ì› : 
 - ì¥ë¹„ : 

3. ì‹ í’ì •ê±°ì¥ í™˜ìŠ¹í†µë¡œ
 1) í™˜ìŠ¹ í„°ë„
  â–  ì‘ì—… ë‚´ìš©
 - ì—°ê²°í„°ë„(PCF) : 
 - ê²½ì‚¬í„°ë„(PCE) :
  â–  ì‹œê³µ í˜„í™©
 - ì—°ê²°í„°ë„(PCF) : 
 - ê²½ì‚¬í„°ë„(PCE) : 
  â–  íˆ¬ì… í˜„í™©
 - ì¸ì› : 
 - ì¥ë¹„ :

 2) ê°œì°© BOX
  â–  ì‘ì—… ë‚´ìš©
 - ë³´ë¼ë§¤ ë°©ë©´ :
 - ëŒ€ë¦¼ ë°©ë©´ :
  â–  ì‹œê³µ í˜„í™©
 - ë³´ë¼ë§¤ ë°©ë©´(êµ¬ì¡°ë¬¼) :
 - ëŒ€ë¦¼ ë°©ë©´(ê°œì°©) :
  â–  íˆ¬ì… í˜„í™©
 - ì¸ì› : 
 - ì¥ë¹„ :

4. ë³¸ì„ í„°ë„(2êµ¬ê°„, ì‹ í’~ë„ë¦¼)
â– ì‘ì—…ë‚´ìš©
- 
â– ì‹œê³µí˜„í™©(ëˆ„ê³„/ì„¤ê³„)
- 
â–  íˆ¬ì…í˜„í™©
- ì¸ì› : 
- ì¥ë¹„ : 

5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥
 1) ì •ê±°ì¥ í„°ë„
 â–  ì‘ì—…ë‚´ìš©
 - 
 â–  ì‹œê³µí˜„í™©(ëˆ„ê³„/ì„¤ê³„)
 - 
 â–  íˆ¬ì…í˜„í™©
 - ì¸ì› : 
 - ì¥ë¹„ : 

 2) ì¶œì…êµ¬#1(PCC,PCA,PHA) ìˆ˜ì§êµ¬ ì—°ê²°í„°ë„
 â–  ì‘ì—…ë‚´ìš©
 -
 â–  ì‹œê³µí˜„í™©
 -
  ã„´ 
 â–  íˆ¬ì…í˜„í™©
 - ì¸ì› : 
 - ì¥ë¹„ : 

 3) ì¶œì…êµ¬#2 (PCC, PHB) ìˆ˜ì§êµ¬ ì—°ê²°í„°ë„
 â–  ì‘ì—…ë‚´ìš©
 -
 â–  ì‹œê³µí˜„í™©(ëˆ„ê³„/ì„¤ê³„)
 -   
 â–  íˆ¬ì…í˜„í™©
 - ì¸ì› :
 - ì¥ë¹„ : 

â–  ì´ ì¸ì› : ##ëª…
â–  ì´ ì¥ë¹„ : ##ëŒ€

â€» ì•ˆì „ê´€ë¦¬ ì¤‘ì  POINT
1)
2)
3)
4)
5)
6)
7)
8)
9)
10)
"""
    # í˜ì´ì§€ë³„ ì…ë ¥/ì¶œë ¥ ìƒíƒœ ì €ì¥
    states = {
        'project_info': '', 'today_work': '', 'issues_solutions': '',
        'generated_report': '', 'qa_log': '', 'is_editing': False,
        'report_edit_content': ''
    }
    for key, value in states.items():
        if key not in st.session_state:
            st.session_state[key] = value

# --- HELPER FUNCTIONS ---
def call_gemini_api(prompt):
    """Gemini APIë¥¼ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜"""
    headers = {"Content-Type": "application/json"}
    data = {
        "contents": [{"parts": [{"text": prompt}]}],
        "safetySettings": [
            {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
        ]
    }
    try:
        response = requests.post(API_ENDPOINT, headers=headers, data=json.dumps(data), timeout=180)
        response.raise_for_status()
        result = response.json()
        return result['candidates'][0]['content']['parts'][0]['text']
    except requests.exceptions.RequestException as e:
        st.error(f"[API í˜¸ì¶œ ì˜¤ë¥˜] {e}")
        return None
    except (KeyError, IndexError) as e:
        st.error(f"[API ì‘ë‹µ ì²˜ë¦¬ ì˜¤ë¥˜] {e}\nì‘ë‹µ ë‚´ìš©: {result}")
        return None

def process_api_response(api_result, all_inputs):
    """API ì‘ë‹µì„ í›„ì²˜ë¦¬í•˜ê³  QA ë¡œê·¸ë¥¼ ë¶„ë¦¬í•©ë‹ˆë‹¤."""
    # QA-CHECKLIST ë‚´ìš© ì¶”ì¶œ ë° ì œê±°
    qa_log_content = ''
    qa_patterns = [
        re.compile(r'QA-CHECKLIST[\s\S]*', re.IGNORECASE),
        re.compile(r'QA[\s-]*CHECKLIST[\s\S]*', re.IGNORECASE),
        re.compile(r'ë³€í™˜ë¡œê·¸[\s\S]*', re.IGNORECASE),
        re.compile(r'USER TEXT \d+[\s\S]*')
    ]
    for pattern in qa_patterns:
        match = pattern.search(api_result)
        if match:
            qa_log_content = match.group(0)
            api_result = api_result.replace(qa_log_content, '')
            break
    
    if not qa_log_content:
        qa_log_content = 'ì¶”ì¶œëœ ë³€í™˜ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.'

    # ì½”ë“œ ë¸”ë¡ ë° ë¶ˆí•„ìš”í•œ ë§ˆí¬ì—… ì œê±°
    api_result = re.sub(r'^```[a-zA-Z]*\s*\n?|```\s*$', '', api_result.strip())
    api_result = re.sub(r'^\s*# MAIN SET\s*\n?', '', api_result, flags=re.IGNORECASE)
    api_result = api_result.replace('**', '')

    # "ì‹ ì•ˆì‚°ì„ ..." ë¬¸ìì—´ ë³€ê²½
    api_result = api_result.replace('ì‹ ì•ˆì‚°ì„  4-1ê³µêµ¬(í¬ìŠ¤ì½”ì´ì•¤ì”¨)', 'â—ì‹ ì•ˆì‚°ì„  4-1ê³µêµ¬(í¬ìŠ¤ì½”ì´ì•¤ì”¨)')
    
    # ì¸ì›/ì¥ë¹„ í•©ì‚°
    total_person = sum(int(n) for n in re.findall(r'(\d+)\s*ëª…', all_inputs))
    total_equip = sum(int(n) for n in re.findall(r'(\d+)\s*ëŒ€', all_inputs))

    final_report = re.sub(r'â–  ì´ ì¸ì› : .*', f'â–  ì´ ì¸ì› : {total_person}ëª…', api_result)
    final_report = re.sub(r'â–  ì´ ì¥ë¹„ : .*', f'â–  ì´ ì¥ë¹„ : {total_equip}ëŒ€', final_report)

    return final_report.strip(), qa_log_content.strip()

def format_qa_log_to_markdown(qa_log):
    """QA ë¡œê·¸ í…ìŠ¤íŠ¸ë¥¼ ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸”ë¡œ ë³€í™˜í•©ë‹ˆë‹¤."""
    if not qa_log or 'ì—†ìŠµë‹ˆë‹¤' in qa_log:
        return qa_log

    qa_log = re.sub(r'QA-CHECKLIST.*?ë³€í™˜ë¡œê·¸:', '', qa_log, flags=re.DOTALL | re.IGNORECASE).strip()
    sections = re.split(r'(?=USER TEXT \d+[^:`]*:`)', qa_log)
    markdown_output = ""

    for section in sections:
        if not section.strip():
            continue
        
        header_match = re.match(r'USER TEXT (\d+)[^:`]*:`', section)
        if header_match:
            user_text_num = header_match.group(1)
            content = section[header_match.end():].strip()
            
            label_map = {
                '1': st.session_state.get('project_info_label', 'ë³¸ì„ í„°ë„(1êµ¬ê°„), ì‹ í’ì •ê±°ì¥'),
                '2': st.session_state.get('today_work_label', 'ì‹ í’ í™˜ìŠ¹í†µë¡œ'),
                '3': st.session_state.get('issues_solutions_label', 'ë³¸ì„ í„°ë„(2êµ¬ê°„), ë„ë¦¼ì •ê±°ì¥'),
            }
            
            markdown_output += f"#### {label_map.get(user_text_num, f'USER TEXT {user_text_num}')}\n"
            
            if "| ë³€ê²½ì‚¬í•­ ì—†ìŒ |" in content:
                markdown_output += "> ë³€ê²½ì‚¬í•­ ì—†ìŒ\n\n"
            else:
                lines = [line.strip() for line in content.split('\n') if line.strip() and line.startswith('|')]
                if len(lines) > 1:
                    markdown_output += '\n'.join(lines) + '\n\n'
                else:
                    markdown_output += f"```\n{content}\n```\n\n"
        else:
            markdown_output += f"```\n{section}\n```\n\n"

    return markdown_output

# --- UI & LOGIC ---
st.set_page_config(
    page_title="AI ì¼ì¼ì‘ì—…ë³´ê³  ìƒì„±ê¸°",
    page_icon="https://raw.githubusercontent.com/primer/octicons/main/icons/note-16.svg",
    layout="wide"
)
initialize_report_session_state()

# ê³µí†µ ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ ì¶”ê°€
st.markdown("""
<style>
    /* ì‚¬ì´ë“œë°” ê³µí†µ ìŠ¤íƒ€ì¼ */
    [data-testid="stSidebar"] {
        background-color: #F8F9FA;
        border-right: 1px solid #E5E7EB;
    }
    [data-testid="stSidebar"] h1 {
        font-size: 1.5rem;
        color: #1E3A8A;
        font-weight: 700;
        padding: 1rem 0;
    }
    /* ë©”ì¸ í°íŠ¸ (ì•„ì´ì½˜ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ [class*="st-"] ì„ íƒì ì œê±°) */
    html, body, .stTextArea, .stButton>button, .stFileUploader, .stSelectbox {
        font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .main .block-container {
        padding: 2rem 2rem 5rem 2rem;
        max-width: 1000px;
    }
</style>
""", unsafe_allow_html=True)

st.title("âœ¨ AI ì¼ì¼ì‘ì—…ë³´ê³  ì·¨í•©ë³¸ ìƒì„±ê¸°")
st.write("ë°œì£¼ì²˜/ê³µë‹¨ ë³´ê³ ìš© í…ìŠ¤íŠ¸ë¥¼ ê°„í¸í•˜ê²Œ ìƒì„±í•˜ì„¸ìš”.")
st.markdown("---")

with st.container(border=True):
    st.session_state.project_info = st.text_area(
        label="ë³¸ì„ í„°ë„(1êµ¬ê°„), ì‹ í’ì •ê±°ì¥", 
        value=st.session_state.project_info, 
        placeholder="ìœ„ì¹˜ë³„ ì‘ì—…ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”",
        height=150,
        key="project_info_input"
    )
    st.session_state.today_work = st.text_area(
        label="ì‹ í’ í™˜ìŠ¹í†µë¡œ",
        value=st.session_state.today_work,
        placeholder="ìœ„ì¹˜ë³„ ì‘ì—…ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”",
        height=200,
        key="today_work_input"
    )
    st.session_state.issues_solutions = st.text_area(
        label="ë³¸ì„ í„°ë„(2êµ¬ê°„), ë„ë¦¼ì •ê±°ì¥",
        value=st.session_state.issues_solutions,
        placeholder="ìœ„ì¹˜ë³„ ì‘ì—…ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”",
        height=150,
        key="issues_solutions_input"
    )

col1, col2 = st.columns(2)
with col1:
    if st.button("ğŸ“„ ë³´ê³ ì„œ ìƒì„±", use_container_width=True, type="primary"):
        if not all([st.session_state.project_info, st.session_state.today_work, st.session_state.issues_solutions]):
            st.warning("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            with st.spinner("ğŸ¤– AIê°€ ë³´ê³ ì„œë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
                user_text = (
                    f"USER TEXT 1: {st.session_state.project_info}\n"
                    f"USER TEXT 2: {st.session_state.today_work}\n"
                    f"USER TEXT 3: {st.session_state.issues_solutions}"
                )
                full_prompt = f"{st.session_state.PROMPT_PAGE1}\n\n{user_text}"
                api_result = call_gemini_api(full_prompt)

                if api_result:
                    report, qa_log = process_api_response(api_result, user_text)
                    st.session_state.generated_report = report
                    st.session_state.report_edit_content = report
                    st.session_state.qa_log = qa_log
                    st.session_state.is_editing = False
                    st.toast("âœ… ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ!", icon="ğŸ‰")

with col2:
    if st.button("ğŸ—‘ï¸ ì´ˆê¸°í™”", use_container_width=True):
        st.session_state.project_info = ''
        st.session_state.today_work = ''
        st.session_state.issues_solutions = ''
        st.session_state.generated_report = ''
        st.session_state.qa_log = ''
        st.session_state.is_editing = False
        st.rerun()

with st.expander("âš™ï¸ í”„ë¡¬í”„íŠ¸ ìˆ˜ì •"):
    edited_prompt = st.text_area(
        "í”„ë¡¬í”„íŠ¸(ì§€ì‹œë¬¸) ìˆ˜ì •",
        value=st.session_state.PROMPT_PAGE1,
        height=300,
        key="prompt_edit_area"
    )
    if st.button("í”„ë¡¬í”„íŠ¸ ì €ì¥", key="save_prompt"):
        st.session_state.PROMPT_PAGE1 = edited_prompt
        st.toast("í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", icon="ğŸ’¾")

if st.session_state.generated_report:
    st.markdown("---")
    st.subheader("ğŸ“‹ ìƒì„±ëœ ë³´ê³ ì„œ")

    if st.session_state.is_editing:
        st.session_state.report_edit_content = st.text_area(
            "ë³´ê³ ì„œ ìˆ˜ì •",
            value=st.session_state.report_edit_content,
            height=400,
            label_visibility="collapsed"
        )
        
        edit_col1, edit_col2 = st.columns(2)
        with edit_col1:
            if st.button("ğŸ’¾ ì €ì¥", use_container_width=True, type="primary"):
                st.session_state.generated_report = st.session_state.report_edit_content
                st.session_state.is_editing = False
                st.toast("ë³´ê³ ì„œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", icon="âœï¸")
                st.rerun()
        with edit_col2:
            if st.button("âŒ ì·¨ì†Œ", use_container_width=True):
                st.session_state.is_editing = False
                st.session_state.report_edit_content = st.session_state.generated_report
                st.rerun()
    else:
        st.text_area(
            "ë³´ê³ ì„œ ë‚´ìš©",
            value=st.session_state.generated_report,
            height=400,
            key="report_output_area",
            label_visibility="collapsed"
        )
        
        btn_col1, btn_col2, btn_col3 = st.columns([1,1,2])
        with btn_col1:
            if st.button("âœï¸ ìˆ˜ì •", use_container_width=True):
                st.session_state.is_editing = True
                st.rerun()
        with btn_col2:
            if st.button("ğŸ“² ê³µì‚¬ì¼ë³´ ìë™í™” ì‹œìŠ¤í…œìœ¼ë¡œ ë³´ë‚´ê¸°", use_container_width=True):
                st.session_state.report_to_transfer = st.session_state.generated_report
                st.toast("âœ… ë³´ê³ ì„œ ë‚´ìš©ì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì„¸ìš”.")
                st.switch_page("pages/2_ê³µì‚¬ì¼ë³´_ìë™í™”.py")
        
        with st.expander("ğŸ“‹ ë³µì‚¬ìš© í…ìŠ¤íŠ¸ (ìš°ì¸¡ ìƒë‹¨ ë³µì‚¬ ë²„íŠ¼ í´ë¦­)", expanded=False):
            st.code(st.session_state.generated_report, language=None)

    if st.session_state.qa_log:
        st.subheader("ğŸ“Š ë³€ê²½ì‚¬í•­")
        formatted_qa_log = format_qa_log_to_markdown(st.session_state.qa_log)
        st.markdown(formatted_qa_log, unsafe_allow_html=True)